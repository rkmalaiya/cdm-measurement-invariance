---
title: "CDM Demo"
output: html_notebook
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
```

# Read Data
```{r}
rm(list = ls())

X = data.ecpe$data
Q = data.ecpe$q.matrix

```

```{r}
X <- X #%>% sample_n(size = 28, replace = FALSE)
```

# Student Performance
## Total marks for each student

```{r}
df.data <- X
df.t <- X %>% mutate(total_marks = rowSums(.[-1]), grand_total = 28, percentage = total_marks / grand_total, 
                     grades = ifelse(percentage >= 0.9, "A",
                                     ifelse(percentage >= 0.8 & percentage < 0.9, "B",
                                            ifelse(percentage >= 0.7 & percentage < 0.8, "C",
                                                   ifelse(percentage >= 0.6 & percentage < 0.7, "D", "F")))
                                     ), grades = factor(grades)) %>%
  
  select(id, total_marks, grand_total, percentage, grades)

df.data = df.data %>% inner_join(df.t)

glimpse(df.data)

```




# Item Performance
## Questions least answered


Below graph shows that none of the questions have been completely answered by students.
```{r}
df.t <- df.data %>% select(id, E1:E28) %>% gather(key="question", value = "answered", -id, factor_key = TRUE) %>% group_by(question) %>% summarise(total_answered = sum(answered), total_students = dim(X)[1], percent = total_answered/total_students, type=ifelse(percent < 0.5, "Difficult Question", "Normal Question"))

df.t <- df.t %>% mutate(question = str_replace(question, "E","Q"))

col_names = df.t$question



df.t %>% mutate(question=factor(question, levels = col_names, ordered = TRUE)) %>%

ggplot() + aes(x=question, y=total_answered, fill = type) + geom_col(alpha = 0.6) + geom_hline(aes(yintercept = dim(X)[1], color = "Total Students"))  + 
  geom_hline(aes(yintercept = min(df.t$total_answered), color = " Least Answered Question"))  + 
  geom_hline(aes(yintercept = max(df.t$total_answered), color = " Most Answered Question"))  + labs(color = "", fill="") # + theme_pubclean()
```

## By Grades
```{r}

df.t <- df.data %>% select(id, grades, E1:E28) %>% gather(key="question", value = "answered", -id, -grades, factor_key = TRUE) %>% group_by(question, grades) %>% summarise(total_answered = sum(answered), total_students = n(), percent = total_answered/total_students, type=ifelse(percent < 0.5, "Difficult Question", "Normal Question"))  %>% ungroup()

df.t %>% mutate(question = factor(str_replace(question, "E","Q"), levels = col_names, ordered = TRUE)) %>%

ggplot() + aes(x=question, y=percent, fill = type) + geom_col(alpha = 0.6, position = position_stack() ) + theme_pubclean() + facet_grid(grades~.) + labs(y = "Percentage", title = "Percentage of students in a particular grade answering a particular Item")+ theme_pubclean() + labs(color = "", fill="")

#ggplot(df.t) + aes(x=question, y=percent, fill = grades) + geom_col(alpha = 0.6, position = position_stack() ) + theme_pubclean() + facet_grid(grades~type) + labs(y = "Percentage", title = "Percentage of students in a particular grade answering a particular Item")
```



# Bootstrap Sample 

Boot requires a custom function that would return row wise stats. In case of dataframe, each row is considered as a multi-variate observation. First parameter of the custom function takes the data input and second parameter takes the importance of data given current bootstrap iteration. stype defines second parameter.

```{r}
total_percent_fn <- function(df, i, df.t2 = df.data) {
  
  df.t <- df.t2[i,]
  
  
  return(mean(df.t$percentage))
  #return (mean(df.t$percentage))

  #return (df.t)
  
} 

X.bt <- boot(data = X %>% select(-id), statistic = total_percent_fn, R = 100, stype = "i")


summary(X.bt)

plot(X.bt)

boot.ci(X.bt, type = c("norm", "basic", "perc", "stud"))
```


```{r}
glimpse(X.bt$t)

```

# Now the actual


```{r}
total_percent_fn <- function(df, i = 1:dim(df)[1]) {
  
  #browser()
  df.t <- df[i,]
  #df.t <- df.data
 df.t <- df.t %>% select(id, E1:E28) %>% gather(key = "questions", value = "answer", -id, factor_key = TRUE) %>% group_by( questions) %>% summarize( percent_questions_answered = sum(answer) / n()) %>% unite("questions", questions) %>% ungroup()
 
 col_order = df.t$questions
 
 df.t1 <- df.t %>% spread(key=1, value = percent_questions_answered, convert = TRUE)  %>% select(!!!col_order)
 
 return(as.matrix(df.t1))
    
} 

t <- total_percent_fn(df.data)

t
```


```{r}

X.bt <- boot(data = df.data , statistic = total_percent_fn, R = 1000, stype = "i")

plot(X.bt)
```

```{r}
#X.bt$t
```

# Extract Data structure for different data divisions

```{r}

df.group_mastery <- X.bt$t[,1:28] %>% as_tibble() %>% mutate(group = "All Population")

df.data.sim <- df.group_mastery 
df.data.sim


```

```{r}
df.t <- df.data.sim
col_names <- colnames(df.t %>% select(-group)) %>% str_replace("V","Q")

df.t %>% gather(key = "questions", value="percent_questions_answered", -group) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, questions) %>% summarise( sampling_mean = mean(percent_questions_answered), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((percent_questions_answered - sampling_mean)^2)/(n() - 1)) )

```

```{r}

df.t %>% gather(key = "questions", value="percent_questions_answered", -group) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, questions) %>% summarise( sampling_mean = mean(percent_questions_answered), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((percent_questions_answered - sampling_mean)^2)/(n() - 1)) ) %>% 
  
  ggplot() + aes(x=questions, y = sampling_mean, color = group) + facet_grid(group ~ .)  +geom_errorbar( aes(ymin=sampling_mean - sampling_error, 
                                                                                                                          ymax=sampling_mean + sampling_error), width=.2) + geom_point(size = 1) + ggtitle("Percentage of students who answered the question right")


```


```{r}

model_dina <- CDM::gdm(X %>% select(-id), Q, progress = FALSE)
model_dina$coef


library(BIFIEsurvey)
 # Data with additional information 5 
timss.info <- data.timss11.G4.AUT.part$data
 # Q-matrix involving combinations between content and cognitive skills 8 
timssq <- data.timss11.G4.AUT.part$q.matrix1
 # Response data 11 
timss <- timss.info[,paste(timssq$item)]
 # Model including all students for calibration of item parameters 14 
timss.all <- gdina(timss, timssq[,-1], progress = FALSE)



```



# Calculate item parameters

```{r}

total_cdm_fn <- function(df, i = 1:dim(df)[1]) {
  
  #browser()
  df.t <- df.data
  df.t <- df[i,]
  
  df.t.s1 <- df.t %>% select(E1:E28) 

  ###########################
  
  df.cdm <- CDM::di@n(df.t.s1, Q, progress=FALSE)
 
   df.t1 <- tibble("value" = df.cdm$slip$est, "key" = paste0("s1_slip_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("s1_slip_E", seq(1,28,1)))
 
  
  df.t2 <- tibble("value" = df.cdm$guess$est, "key" = paste0("s1_guess_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("s1_guess_E", seq(1,28,1)))
  
  
  df.t <- cbind(df.t1, df.t2)
  
 return(as.matrix(df.t))
    
} 

t_cdm <- total_cdm_fn(df.data)

t_cdm 
```

```{r}
df.data.p1 <- df.data %>% sample_frac(size = 0.5)
df.data.p2 <- df.data %>% anti_join(df.data.p1)

X.bt.1 <- boot(data = df.data , statistic = total_cdm_fn, R = 1000, stype = "i")
X.bt.2 <- boot(data = df.data , statistic = total_cdm_fn, R = 1000, stype = "i")


plot(X.bt.1)
```

```{r}


#unique(df.data$mastery_n)



df.s1_slip <- X.bt.1$t[,1:28] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Partition 1")
df.s1_guess <- X.bt.1$t[,29:56] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Partition 1")


df.s2_slip <- X.bt.2$t[,1:28] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Partition 2")
df.s2_guess <- X.bt.2$t[,29:56] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Partition 2")


df.data.sim <- df.s1_slip %>% bind_rows(df.s1_guess) %>% bind_rows(df.s2_slip) %>% bind_rows(df.s2_guess) 
df.data.sim


```

```{r}
df.plot <- df.data.sim
col_names <- colnames(df.t %>% select(-group)) %>% str_replace("V","Q")
colnames(df.data.sim) <- colnames(df.data.sim) %>% str_replace("V","Q")

# For viewing purposes only
df.plot %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, parameter, questions) %>% summarise( sampling_mean = mean(item_parameters), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)) )

```


```{r}
df.plot <- df.plot %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, parameter, questions) %>% summarise( sampling_mean = mean(item_parameters), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)) ) %>% ungroup() 
```


```{r}

df.plot %>%
  
  ggplot() + aes(x=questions, y = sampling_mean, color = parameter) + facet_grid(group ~ .  )  +geom_pointrange( aes(ymin=sampling_mean - sampling_error, 
                                                                                                                          ymax=sampling_mean + sampling_error), width=.2) + geom_point(size = 1) + theme(strip.text.y = element_text(angle = 0)) + ggtitle("Item Parameters estimated over 1000 Bootstrap samples")


```




```{r}

df.plot  %>% 
  
  ggplot() + aes(x=questions, y = sampling_mean, color = group) + facet_grid(parameter ~ questions, scales = "free_x"  )  +
  
  geom_pointrange(position=position_dodge(width=0.5), aes(ymin=sampling_mean - sampling_error, ymax=sampling_mean + sampling_error), width=.2) +
  
  geom_point(position=position_dodge(width=0.5), size = 1) + theme(strip.text.y = element_text(angle = 0)) + ggtitle("Item Parameters estimated over 1000 Bootstrap samples") + theme(axis.text.x = element_text() , strip.background.x = element_rect(fill = "white"), axis.ticks.x = element_blank()) + labs(x="Questions / Items", y = "Sampling Mean with Sampling error") + scale_color_brewer(palette="Dark2")


```


```{r}

df.plot %>% select(-sampling_error) %>% spread(key = group, value = "sampling_mean") %>%
  
  ggplot() + aes(x=`Partition 1`, y = `Partition 2`) + geom_text(aes(label = questions)) + geom_abline(aes(intercept = 0, slope = 1)) + facet_wrap(parameter~., scales = "free")

```

```{r}

df.data.sim %>% group_by(group) %>% mutate(id=1:n()) %>% ungroup() %>% 
  gather(key = "key", value = "value", -parameter, -group, -id) %>% 
  mutate(id = paste(id,key)) %>% select(-key) %>% arrange(id, group, parameter) %>% 
  spread(key= "group", value = "value") %>% separate(id,c("id","question"), " " ) %>% select(-id)  %>%
  
  ggplot() + aes(x = `Partition 1`, y = `Partition 2`, color = question) + geom_point() + facet_wrap(.~parameter, scales = "free")



```

```{r}

df.data.sim %>% group_by(group) %>% mutate(id=1:n()) %>% ungroup() %>% 
  gather(key = "key", value = "value", -parameter, -group, -id) %>% 
  arrange(id, group, parameter) %>%
  
  ggplot() + aes(x = key, y = value, fill = group) + geom_boxplot() + facet_wrap(.~parameter, scales = "free")



```



