---
title: "Plots to publish"
output: html_notebook
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
```

```{r}
rm(list = ls())
options(max.print=100)
```


```{r}
df.error.ec <- read_rds("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\df_error_ecpe.rds")

df.error.ec.agg <- read_rds("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\df_error_agg_ecpe.rds")

df.error.ec.plot <- df.error.ec %>% inner_join(
  df.error.ec.agg
) %>% mutate(dataset = "ECPE")

df.error.ec.plot


```


```{r}
df.error.ti <- read_rds("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\df_error_timss.rds")

df.error.ti.agg <- read_rds("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\df_error_agg_timss.rds")

df.error.ti.plot <- df.error.ti %>% inner_join(
  df.error.ti.agg
) %>% mutate(dataset = "TIMSS")

df.error.ti.plot


```

```{r}
df.error.ss <- read_rds("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\df_error_socialscience.rds")

df.error.ss.agg <- read_rds("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\df_error_agg_socialscience.rds")

df.error.ss.plot <- df.error.ss %>% inner_join(
  df.error.ss.agg
) %>% mutate(dataset = "Social Science")

df.error.ss.plot

```

# Merge all Data

```{r}

df.error.plot <- df.error.ec.plot %>% union(df.error.ti.plot) %>% union(df.error.ss.plot) %>%
  mutate(ratio_n = ratio) %>%
  mutate(ratio = factor(ratio, levels = sort(unique(as.numeric(ratio))), ordered = TRUE)) %>%
  mutate(dataset = factor(dataset, levels = c("ECPE", "TIMSS", "Social Science"))) %>%
  mutate(questions = factor(questions)) %>% 
  group_by(dataset, group, parameter, sample_size) %>%
  mutate(question_n = n(), qsr = round(n()/sample_size)) %>% 
  
  # Average avg_attempts between partitions
  group_by(dataset, parameter, sample_size) %>%
  mutate(avg_attempts = round(mean(avg_attempts))) %>%
  
  ungroup() %>%
  arrange(dataset, group, parameter, sample_size)

df.error.plot <- df.error.plot %>% mutate(qsr = factor(qsr, ordered = TRUE), 
                                          sample_size = factor(sample_size, ordered = TRUE), 
                                          avg_attempts = factor(avg_attempts, ordered = TRUE)
                                          )
df.error.plot 
```

# TIMSS 
```{r}
df.error.ec.plot %>% filter(avg_attempts == 140)  %>%
  ggplot() + 
  aes(x=str_trunc(questions, 5, side = "center", ellipsis = "."), 
      y=sampling_mean, color = group) + 
  geom_point(position = position_dodge(width = 0.8)) + 
  geom_errorbar(aes(ymin = sampling_mean-sampling_error, ymax = sampling_mean+sampling_error), position = position_dodge(width = 0.8)) + 
  facet_wrap(parameter~.) + 
  labs(x="Questions", title = "TIMSS: For Average 47 Students per Item ") + 
  ggpubr::theme_pubclean() + 
  theme(legend.position = "bottom", axis.text.x = element_text(size = 5)) + 
  labs(color = "")
  
  
  
  
```


# Sampling Error

```{r}

df.error.plot %>% #filter(parameter == "Guess") %>%
  ggplot() + 
  aes(x=avg_attempts, y=sampling_error, fill = group) +
  #geom_boxplot(alpha = 0.4, show.legend = FALSE) +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
  geom_point(aes(y=sampling_error_mean), size = 1, show.legend = FALSE) + 
  
  labs(x="Student to Item Ratio", color="") +
  facet_grid(dataset~parameter) + 
  ggtitle("Sampling Error for each Sample Size") + ggpubr::theme_pubclean() + 
   theme(legend.position = "bottom") + 
  labs(subtitle = "Item Parameters")


```

```{r}

df.error.plot %>% #filter(parameter == "Guess") %>%
  ggplot() + 
  aes(x=avg_attempts, y=sampling_error, fill = group) +
  geom_boxplot(alpha = 0.4, show.legend = FALSE, color = "grey38") +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1.1) + 
  geom_point(aes(y=sampling_error_mean), size = 1, show.legend = FALSE) + 
  
  labs(x="Average students attempting each Question", color="", y = "Sampling Error") +
  facet_grid(dataset~paste(parameter, "Parameter")) + 
  ggtitle("Distribution containing Sampling Error for each Sample Size") + ggpubr::theme_pubclean() + 
  theme(legend.position = "bottom", axis.text.x = element_text(size = 7)) 

```


```{r}

df.error.plot %>% select(parameter, group, questions, sampling_mean, avg_attempts, ratio, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% arrange(avg_attempts) %>% #filter(parameter == "Guess") %>%
  
  
  
  ggplot() + 
  aes(x=`Partition 1`, y=`Partition 2`, color = parameter) +
  geom_point(show.legend = TRUE, alpha = 0.4) +
  facet_grid(dataset~avg_attempts, scales = "free") + 
  ggtitle("Distribution of Sampling Mean for each Sample Size") + 
  scale_x_continuous(breaks = c(0,0.5)) + 
  scale_y_continuous(breaks = c(0,0.5)) + 
  ggpubr::theme_pubclean() + 
  labs(color = "", subtitle = "Student Sample Size") + 
  theme(legend.position = "bottom")

```

```{r}
df.error.plot %>% select(parameter, group, questions, sampling_mean, sample_size, avg_attempts, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% arrange(sample_size) %>% mutate(diff = (`Partition 1` - `Partition 2`)^2) %>% group_by(parameter, avg_attempts, dataset) %>% summarise(rms = mean(diff)^(1/2)) %>% 
  
  ggplot() + 
  aes(x=avg_attempts, y = rms, color = paste(parameter, "Parameter"), group = parameter) + 
  geom_line() + 
  geom_point(color="black") +
  facet_grid(dataset~.) + 
  labs(y="Distribution of Sample Means", x = "Student to item ratio", color="", title = "Difference between Sample Means of both Partitions") + theme_pubclean() + theme(legend.position = "bottom") + scale_y_continuous(breaks = c(0.01,0.1,0.2,0.3,0.4))
```


```{r}
df.error.plot %>% select(parameter, group, questions, sampling_mean, sample_size, avg_attempts, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% arrange(sample_size) %>% mutate(diff = (`Partition 1` - `Partition 2`)^2) %>% group_by(parameter, avg_attempts, dataset) %>% mutate(rms = mean(diff)^(1/2)) %>% 
  
  ggplot() + 
  aes(x=avg_attempts, y = rms, color = paste(parameter, "Parameter"), fill = paste(parameter, "Parameter")) + 
  geom_line(size = 1.1, show.legend = TRUE, aes(group = parameter)) + 
  #geom_point(aes(y=diff), position = position_jitterdodge(dodge.width = 0.9), alpha = 0.04,show.legend = FALSE) + 
  geom_boxplot(aes(y=diff), alpha = 0.4, show.legend = FALSE, color = "grey38") +
  facet_grid(dataset~.) + 
  labs(y="Distance between Sample Means", x = "Average students attempting each Question", 
       color="", title = "Distribution of Distance between Sample Means of both Partitions",
       color="", fill = "") + 
  theme_pubclean() + theme(legend.position = "bottom", axis.text.x = element_text(size = 7)) + 
  scale_y_continuous(breaks = c(0.01,0.3, 0.5,0.7,0.9))
```

```{r}

df.error.plot %>% 
  group_by(dataset, group, parameter, avg_attempts) %>%
  mutate(sampling_mean_mean = mean(sampling_mean)) %>%
  ungroup() %>%
  ggplot() + 
  aes(x=avg_attempts, y=sampling_mean, fill = group) +
  geom_boxplot(alpha = 0.4, show.legend = FALSE, color = "grey38") +
  #geom_line(aes(y=mean(sampling_mean), color = group, group = group), linetype = 1, size = 1.1) + 
  #geom_point(aes(y=mean(sampling_mean)), size = 1, show.legend = FALSE) + 
  
  geom_line(aes(y=sampling_mean_mean, color = group, group = group), linetype = 1, size = 1.1) + 
  geom_point(aes(y=sampling_mean_mean), size = 1, show.legend = FALSE) + 
  
  labs(x="Average students attempting each Question", color="", y = "Sampling Mean") +
  facet_grid(dataset~paste(parameter, "Parameter")) + 
  ggtitle("Distribution Containing Sampling Mean for each Sample Size") + ggpubr::theme_pubclean() + 
   theme(legend.position = "bottom", axis.text.x = element_text(size = 7)) 

```

```{r}

df.error.plot %>% 
  group_by(dataset, group, parameter, avg_attempts) %>%
  mutate(sampling_mean_mean = mean(sampling_mean)) %>%
  ungroup() %>%
  ggplot() + 
  aes(x=avg_attempts, y=sampling_mean, fill = group) +
  geom_violin(alpha = 0.4, show.legend = FALSE) +
  #geom_line(aes(y=mean(sampling_mean), color = group, group = group), linetype = 1, size = 1.1) + 
  #geom_point(aes(y=mean(sampling_mean)), size = 1, show.legend = FALSE) + 
  
  geom_line(aes(y=sampling_mean_mean, color = group, group = group), linetype = 1, size = 1.1) + 
  geom_point(aes(y=sampling_mean_mean), size = 1, show.legend = FALSE) + 
  
  labs(x="Average students attempting each Question", color="", y = "Sampling Mean") +
  facet_grid(dataset~paste(parameter, "Parameter")) + 
  ggtitle("Distribution Containing Sampling Mean for each Sample Size") + ggpubr::theme_pubclean() + 
   theme(legend.position = "bottom", axis.text.x = element_text(size = 7)) 

```

```{r}

df.error.plot %>% select(parameter, group, questions, sampling_mean, sample_size, avg_attempts, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% arrange(sample_size) %>% #filter(parameter == "Guess") %>%
  
  
  
  ggplot() + 
  aes(x=`Partition 1`, y=`Partition 2`, color = dataset) +
  geom_point(show.legend = TRUE, alpha = 0.4) +
  facet_grid(dataset+parameter~avg_attempts, scales = "free") + 
  ggtitle("Sampling Mean of Each Item") + 
  scale_x_continuous(breaks = c(0,0.5)) + 
  scale_y_continuous(breaks = c(0,0.5)) + 
  ggpubr::theme_pubclean() + 
  labs(color = "", subtitle = "Student to Item Ratio") + 
  theme(legend.position = "bottom")

```



