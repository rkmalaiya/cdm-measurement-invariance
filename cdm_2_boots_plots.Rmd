---
title: "Plots to publish"
output:
  pdf_document: 
    fig_height: 8
    fig_width: 14
  html_notebook: default
  word_document: 
    fig_height: 8
    fig_width: 14
  html_document: 
    fig_height: 8
    fig_width: 14
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
library(ggridges)
library(ggrepel)
```

```{r}
rm(list = ls())
options(max.print=100)
#path = "report"
path = ""


```


```{r}
df.error.ec <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_ecpe.rds"))

df.error.ec.agg <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_ecpe.rds"))

df.error.ec.fit <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_ecpe.rds")) %>% mutate(dataset = "ECPE")

df.error.ec.plot <- df.error.ec %>% inner_join(
  df.error.ec.agg
) %>% mutate(dataset = "ECPE")

df.error.ec.plot


```


```{r}
df.error.ti <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_timss.rds"))

df.error.ti.agg <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_timss.rds"))

df.error.ti.fit <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_timss.rds")) %>% mutate(dataset = "TIMSS")

df.error.ti.plot <- df.error.ti %>% inner_join(
  df.error.ti.agg
) %>% mutate(dataset = "TIMSS")


```

```{r}
df.error.ss <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_socialscience.rds"))

df.error.ss.agg <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_socialscience.rds"))

df.error.ss.fit <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_socialscience.rds")) %>% mutate(dataset = "Social Psychology")

df.error.ss.plot <- df.error.ss %>% inner_join(
  df.error.ss.agg
) %>% mutate(dataset = "Social Psychology (Original)")

df.error.ss.plot

```

```{r}
df.error.ss.u <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_upsample_socialscience.rds"))

df.error.ss.agg.u <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_upsample_socialscience.rds"))

df.error.ss.fit.u <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_upsample_socialscience.rds")) %>% mutate(dataset = "Social Psychology (Upsample)")

df.error.ss.plot.u <- df.error.ss.u %>% inner_join(
  df.error.ss.agg.u
) %>% mutate(dataset = "Social Psychology")

df.error.ss.plot.u

```


```{r}

df.error.ss.plot.u %>% 
  ggplot() + 
  aes(x = attempts, y = sampling_error) + 
  facet_wrap(group~.)+
  geom_col()



```




# Merge all Data

```{r}

df.error.plot <- df.error.ec.plot %>% bind_rows(df.error.ti.plot) %>% bind_rows(df.error.ss.plot.u) %>% #bind_rows(df.error.ss.plot) %>% 
  
  mutate(ratio_n = as.numeric(student_question_ratio)) %>%
  
  mutate(student_question_ratio = factor(student_question_ratio, levels = sort(unique(as.numeric(student_question_ratio))), ordered = TRUE)) %>%
  
  mutate(dataset = factor(dataset, levels = c("ECPE", "TIMSS", "Social Psychology"))) %>% #
  
  mutate(questions = factor(questions)) %>% 
  
  group_by(dataset, group, parameter, sample_size) %>%
  
  mutate(question_n = n(), qsr = round(n()/sample_size)) %>% 
  
  mutate(attempts = round(attempts)) %>% 
  
  #Average attempts between partitions for each question.
  group_by(dataset, parameter, questions, student_question_ratio) %>%
  mutate(attempts_disc_n = round(mean(attempts))) %>% ungroup() %>%
  mutate(attempts_disc = cut(attempts_disc_n, 
                        breaks = c(0,5,10,15,20,25,30,40,50,60, 100, 200, 400, 800, 1000, max(.$attempts)),
                        labels = c(5,10,15,20,25,30,40,50,60, 100, 200, 400, 800, 1000, "1000+"),
                        include.lowest = TRUE, right = TRUE, ordered_result = TRUE))  %>%
  
  # Adding upsample column to represent attempts that were generated due to non-parameteric bootstrap upsampling
  mutate(upsampled = "Original Dataset") %>%
  mutate(upsampled = case_when(
    (dataset == "TIMSS" & attempts_disc_n > 400)  ~ "Upsampled Dataset",
    (dataset == "Social Psychology" & attempts_disc_n > 15)  ~ "Upsampled Dataset",
    TRUE ~ "Original Dataset"
    
    
  )) %>%
  
  
  #mutate(sampling_error = sampling_error / sqrt(1000)) %>% # To get Smulation Error
  
  # Average avg_attempts between partitions aggregated over all questions.
  
  group_by(dataset, parameter, attempts) %>%
  mutate(avg_attempts = round(mean(avg_attempts))) %>%
  
  ungroup() %>%
  arrange(dataset, group, parameter, sample_size)

df.error.plot <- df.error.plot %>% mutate(qsr = factor(qsr, ordered = TRUE), 
                                          sample_size = factor(sample_size, ordered = TRUE), 
                                          avg_attempts = factor(avg_attempts, ordered = TRUE)
                                          )
distinct(df.error.plot, dataset, upsampled, student_question_ratio, attempts_disc_n) 

summary(df.error.plot$attempts)


```

```{r}

df.fit.plot <- df.error.ec.fit %>% bind_rows(df.error.ti.fit) %>% bind_rows(df.error.ss.fit) %>% bind_rows(df.error.ss.fit.u)
#df.fit.plot

```


# Sampling Error



```{r}

df.error.plot %>% select(parameter, group, questions, sampling_mean, attempts_disc, student_question_ratio, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% arrange(attempts_disc) %>% filter(parameter == "Guess") %>%
  
  
  
  ggplot() + 
  aes(x=`Partition 1`, y=`Partition 2`, color = parameter) +
  geom_point(show.legend = TRUE, alpha = 0.4) +
  facet_grid(dataset~attempts_disc, scales = "free") + 
  ggtitle("Distribution of Sampling Mean for each Sample Size") + 
  scale_x_continuous(breaks = c(0,0.5)) + 
  scale_y_continuous(breaks = c(0,0.5)) + 
  ggpubr::theme_pubclean() + 
  labs(color = "", subtitle = "Student Sample Size") + 
  theme(legend.position = "bottom")

```


```{r}

df.mean_diff <- df.error.plot  %>% select(parameter, group, questions, sampling_mean, student_question_ratio, attempts_disc, dataset, upsampled) %>% 
  spread(key="group", value = "sampling_mean") %>% rename("Partition1_mean" = `Partition 1`, "Partition2_mean" = `Partition 2`)  %>% 
  
  group_by(dataset,parameter,student_question_ratio,questions) %>% 
  mutate(mean_diff = Partition1_mean - Partition2_mean)  
  

df.error_diff <- df.error.plot  %>% select(parameter, group, questions, sampling_error, student_question_ratio, attempts_disc, dataset, upsampled) %>% 
  spread(key="group", value = "sampling_error") %>% rename("Partition1_error" = `Partition 1`, "Partition2_error" = `Partition 2`)  %>% 
  
  group_by(dataset,parameter,student_question_ratio,questions) %>% 
  mutate(error_diff = Partition1_error - Partition2_error)  

  
```



# Plots of mean difference
```{r}

df.diff <- df.mean_diff %>% group_by(dataset, parameter, attempts_disc) %>% #,attempts, student_question_ratio
  summarize(
    mn = median(mean_diff),
    sd = sd(mean_diff),
    min = min(mean_diff),
    max = max(mean_diff),
    var = var(mean_diff)
    
  )

df.diff

```


# Plot for poster presentation



```{r}

gg.plot <- df.diff %>% group_by(dataset, parameter)%>% arrange(dataset, parameter, attempts_disc) %>% 
  mutate(first = first(var)) %>% mutate(diff_from_first = ((var-first)/first) ) %>% 
  
  ggplot() + 
  aes(x= attempts_disc, y = var) + #avg_attempts
  geom_line(aes(group = dataset), size = 1.3) + 
  #geom_point() +
  #geom_col() +
  facet_grid(dataset~parameter,scales = "free") + 
  
  labs(x = "Examinee Attempts on Item", 
       y = "Variance", 
       title = "Measure of Spread of Sampling Mean Difference") +
  
   geom_text_repel(aes(label = paste0(round(diff_from_first*100,2),"%")), size = 3.6, direction = "y") + #round(var,2), ";", 
  theme_pubclean()

gg.plot

```


```{r}

df.diff %>% group_by(dataset, parameter)%>% arrange(dataset, parameter, attempts_disc) %>% 
  mutate(first = first(sd)) %>% mutate(diff_from_first = ((sd-first)/first) ) %>% 
  
  ggplot() + 
  aes(x=attempts_disc, y = sd) + #diff_from_first
  geom_line(aes(group = dataset)) + 
  facet_grid(dataset~parameter,scales = "free") + 
  
 labs(x = "Examinee Attempts on Item", 
       y = "Standard Deviation", 
       title = "Measure of Spread of Sampling Mean Difference") +
  
  geom_label(aes(label = paste0(round(sd,2), ";", round(diff_from_first*100,2),"%"))) #+ 
  #scale_y_continuous(labels=scales::percent_format(accuracy = 1))


```

# Item parameter difference between partitions

```{r}
df.mean_diff
```



```{r}

df.mean_diff %>% #filter(dataset != "Social Psychology") %>%  #mutate(avg_attempts = as.integer(avg_attempts)) %>%
  ggplot() + 
  
  aes(x =attempts_disc, y = mean_diff, color = upsampled) + 
  geom_boxplot() + 
  facet_grid(parameter~dataset, scales = "free") + 
  labs(title = "Distribution of Difference between Item parameters in 2 sub-populations", x = "Attempts per item", y = "Difference of Sampling Mean", color = "")+ 
  theme_pubclean() + theme(legend.position = "bottom")

```


```{r}

df.error_diff %>% #filter(dataset != "Social Psychology") %>% #mutate(avg_attempts = as.integer(avg_attempts)) %>%
  ggplot() + 
  
  aes(x =attempts_disc, y = error_diff, color = upsampled) + 
  geom_boxplot() + 
  facet_grid(parameter~dataset, scales = "free") + 
  labs(title = "Distribution of Difference between Item parameters in different sub-population", x = "Attempts per item", y = "Difference of Sampling Error", color = "") + 
  theme_pubclean() + theme(legend.position = "bottom")

```



```{r}

df.mean_diff  %>% #filter(dataset == "Social Psychology" | avg_attempts > 14) %>%
  
  
  ggplot() + 
  aes(y=attempts_disc, x=mean_diff) +
  
  geom_density_ridges(aes(height = ..density..), 
                      stat = "density", rel_min_height=0.01, 
                      alpha = 0.3
                       ) +
  
  #labs(y = "Student count (average) attempting each item", x = "Mean Difference between partitions", title = "") + 
  labs(y = "Student count (average) attempting each item", x = "Item-Parameter Bias Relative difference", title = "") + 
  geom_vline(aes(xintercept = 0.02), linetype = 2) + 
  geom_vline(aes(xintercept = -0.02), linetype = 2) + 
  #theme_pubclean() + 
  facet_grid(dataset ~ parameter, scales = "free", 
             labeller = label_wrap_gen(width = 10, multi_line = FALSE))  + 
    theme(axis.text.x = element_text(size = 12), 
          axis.text.y = element_text(size = 10.5),
          strip.text.x = element_text(size = 14),
          strip.text.y = element_text(size = 14),
          axis.title.x = element_text(size = 18),
          axis.title.y = element_text(size = 16)
          
          ) #+ scale_x_continuous(limits = c(-3,3), breaks = seq(-3,3,1))

  
```



# EDA Model Fit

Need to take average because for different sample sizes there can be same number of attempts

```{r}

df.fit.plot.attempts <- df.fit.plot %>% group_by(group, parameter, fit, dataset, sample_size) %>% summarise_all(.funs = mean)
#df.fit.plot.attempts
```


```{r}


df.fit.plot.attempts %>% arrange(sample_size) %>% distinct(group, sample_size, dataset) %>% filter(dataset == "Social Psychology (Upsample)") %>% filter(group == "Partition 2")

```


```{r}

df.fit.plot.attempts %>% #filter(group == "Partition 1") %>%
  
  ggplot() +
  aes(x=attempts, y=sampling_error, color = dataset, group = group) +
  geom_line() +
  geom_label(aes(label = round(sampling_error,6)))+
  geom_hline(aes(yintercept=0.05),linetype="dotted") +
  #scale_x_continuous(limits = c(0,300)) + 
  facet_grid(group~dataset,scales = "free")
  
  
  
  

```





