---
title: "Plots to publish"
output:
  pdf_document: 
    fig_height: 8
    fig_width: 14
  html_notebook: default
  word_document: 
    fig_height: 8
    fig_width: 14
  html_document: 
    fig_height: 8
    fig_width: 14
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
library(ggridges)
library(ggrepel)
```

```{r}
rm(list = ls())
options(max.print=100)
#path = "report"
path = ""


```


```{r}
df.error.ec <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_ecpe.rds"))

df.error.ec.agg <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_ecpe.rds"))

df.error.ec.fit <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_ecpe.rds")) %>% mutate(dataset = "ECPE")

df.error.ec.plot <- df.error.ec %>% inner_join(
  df.error.ec.agg
) %>% mutate(dataset = "ECPE")

df.error.ec.plot


```


```{r}
df.error.ti <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_timss.rds"))

df.error.ti.agg <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_timss.rds"))

df.error.ti.fit <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_timss.rds")) %>% mutate(dataset = "TIMSS")

df.error.ti.plot <- df.error.ti %>% inner_join(
  df.error.ti.agg
) %>% mutate(dataset = "TIMSS")

df.error.ti.plot


```

```{r}
df.error.ss <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_socialscience.rds"))

df.error.ss.agg <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_socialscience.rds"))

df.error.ss.fit <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_socialscience.rds")) %>% mutate(dataset = "Social Psychology (Upsample)")

df.error.ss.plot <- df.error.ss %>% inner_join(
  df.error.ss.agg
) %>% mutate(dataset = "Social Psychology (UpSampled)")

df.error.ss.plot

```

```{r}
df.error.ss.u <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_upsample_socialscience.rds"))

df.error.ss.agg.u <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_agg_upsample_socialscience.rds"))

df.error.ss.fit.u <- read_rds(paste0("..\\data\\FirstYearProject\\",path,"\\df_error_fit_upsample_socialscience.rds")) %>% mutate(dataset = "Social Psychology (Upsample)")

df.error.ss.plot.u <- df.error.ss.u %>% inner_join(
  df.error.ss.agg.u
) %>% mutate(dataset = "Social Psychology")

df.error.ss.plot.u

```

# Merge all Data

```{r}

df.error.plot <- df.error.ec.plot %>% bind_rows(df.error.ti.plot) %>% bind_rows(df.error.ss.plot) %>% bind_rows(df.error.ss.plot.u) %>%
  mutate(ratio_n = student_question_ratio) %>%
  mutate(student_question_ratio = factor(student_question_ratio, levels = sort(unique(as.numeric(student_question_ratio))), ordered = TRUE)) %>%
  mutate(dataset = factor(dataset, levels = c("ECPE", "TIMSS", "Social Psychology (UpSampled)"))) %>%
  mutate(questions = factor(questions)) %>% 
  group_by(dataset, group, parameter, sample_size) %>%
  mutate(question_n = n(), qsr = round(n()/sample_size)) %>% 
  
  #mutate(sampling_error = sampling_error / sqrt(1000)) %>% # To get Smulation Error
  
  # Average avg_attempts between partitions
  group_by(dataset, parameter, sample_size) %>%
  mutate(avg_attempts = round(mean(avg_attempts))) %>%
  
  ungroup() %>%
  arrange(dataset, group, parameter, sample_size)

df.error.plot <- df.error.plot %>% mutate(qsr = factor(qsr, ordered = TRUE), 
                                          sample_size = factor(sample_size, ordered = TRUE), 
                                          avg_attempts = factor(avg_attempts, ordered = TRUE)
                                          )
df.error.plot %>% group_by(group, parameter, attempts) %>% top_n(2) %>% select(questions, sampling_mean, sampling_error)
```

```{r}

df.fit.plot <- df.error.ec.fit %>% bind_rows(df.error.ss.fit) %>% bind_rows(df.error.ti.fit)
df.fit.plot

```

Need to take average because for different sample sizes there can be same number of attempts

```{r}

df.fit.plot.attempts <- df.fit.plot %>% group_by(group, parameter, fit, dataset, sample_size) %>% summarise_all(.funs = mean)
df.fit.plot.attempts
```



# Sampling Error

```{r}

df.error.plot %>% #filter(parameter == "Guess") %>%
  ggplot() + 
  aes(x=avg_attempts, y=sampling_error, fill = group) +
  #geom_boxplot(alpha = 0.4, show.legend = FALSE) +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
  geom_point(aes(y=sampling_error_mean), size = 1, show.legend = FALSE) + 
  
  labs(x="Student to Item Ratio", color="") +
  facet_grid(dataset~parameter) + 
  ggtitle("Sampling Error for each Sample Size") + ggpubr::theme_pubclean() + 
   theme(legend.position = "bottom") + 
  labs(subtitle = "Item Parameters")


```

```{r}

df.error.plot %>% #filter(parameter == "Guess") %>%
  ggplot() + 
  aes(x=avg_attempts, y=sampling_error, fill = group) +
  geom_boxplot(alpha = 0.4, show.legend = FALSE, color = "grey38") +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1.1) + 
  geom_point(aes(y=sampling_error_mean), size = 1, show.legend = FALSE) + 
  
  labs(x="Average students attempting each Question", color="", y = "Sampling Error") +
  facet_grid(dataset~paste(parameter, "Parameter")) + 
  ggtitle("Distribution containing Sampling Error for each Sample Size") + ggpubr::theme_pubclean() + 
  theme(legend.position = "bottom", axis.text.x = element_text(size = 7)) 

```


```{r}

df.error.plot %>% select(parameter, group, questions, sampling_mean, avg_attempts, student_question_ratio, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% arrange(avg_attempts) %>% #filter(parameter == "Guess") %>%
  
  
  
  ggplot() + 
  aes(x=`Partition 1`, y=`Partition 2`, color = parameter) +
  geom_point(show.legend = TRUE, alpha = 0.4) +
  facet_grid(dataset~avg_attempts, scales = "free") + 
  ggtitle("Distribution of Sampling Mean for each Sample Size") + 
  scale_x_continuous(breaks = c(0,0.5)) + 
  scale_y_continuous(breaks = c(0,0.5)) + 
  ggpubr::theme_pubclean() + 
  labs(color = "", subtitle = "Student Sample Size") + 
  theme(legend.position = "bottom")

```



```{r}
df.error.plot
```


```{r}

df.t <- df.error.plot #%>%   #%>% filter(dataset == "TIMSS")
#mutate(sampling_mean = round(sampling_mean, 2),
#       sampling_error = round(sampling_error, 2)
#       )

df.mean_diff <- df.t  %>% select(parameter, group, questions, sampling_mean, avg_attempts, dataset) %>% 
  spread(key="group", value = "sampling_mean") %>% rename("Partition1_mean" = `Partition 1`, "Partition2_mean" = `Partition 2`) %>% 
  inner_join(
    
    df.t  %>% select(parameter, group, questions, sampling_error, avg_attempts, dataset) %>% 
  spread(key="group", value = "sampling_error") %>% rename("Partition1_error" = `Partition 1`, "Partition2_error" = `Partition 2`)
    
  ) %>% group_by(dataset,parameter,avg_attempts,questions) %>% mutate(
                                                                      diff = Partition1_mean - Partition2_mean,
                                                                      #Z_test = diff / 
                                                                      #  ( sqrt( ( (Partition1_error^2) ) + ((Partition2_error^2)) + 0.001^2 ) ) #  
                                                                      Z_test = diff / Partition1_mean,
                                                                      #  ( sqrt( ( (Partition1_error^2) ) + ((Partition2_error^2)) + 0.001^2 ) )
                                                                     
                                                                     ) %>% 
  
  #filter(Z_test > -250 & Z_test < 250) %>%
  group_by(dataset,parameter,avg_attempts) %>% mutate(Z_avg = mean(Z_test, na.rm = TRUE)) %>% ungroup()

df.mean_diff %>% arrange(dataset, Z_test, questions, avg_attempts) %>% filter(parameter == "Guess") %>% select(-Z_avg) 

```

```{r}

t <- df.t  %>% select(parameter, group, questions, sampling_mean, avg_attempts, dataset, sample_size) %>% 
  spread(key="group", value = "sampling_mean") %>% rename("Partition1_mean" = `Partition 1`, "Partition2_mean" = `Partition 2`) 

t[c(7387, 8326, 9265, 10204, 11143, 12082),]

```


# Plots of mean difference
```{r}

df.diff <- df.mean_diff %>% group_by(dataset, parameter, avg_attempts) %>%
  summarize(
    mn = median(diff),
    sd = sd(diff),
    min = min(diff),
    max = max(diff)
    
  )

df.diff

```


# Plot for poster presentation
```{r}

df.diff %>% ggplot() + 
  aes(x=avg_attempts, y = sd, color = dataset) + 
  geom_line(aes(group = dataset)) + 
  facet_grid(.~parameter,scales = "free") + labs(x = "Average Student Attempts", y = "Standard Deviation", title = "Standard Deviation of Sampling Mean Difference") +
  geom_label_repel(aes(label = round(sd,2))) 


```


```{r}

df.diff %>% group_by(dataset, parameter)%>% arrange(dataset, parameter, avg_attempts) %>% mutate(first = first(sd)) %>% mutate(diff_from_first = ((sd-first)/first) ) %>% 
  
  ggplot() + 
  aes(x=avg_attempts, y = diff_from_first, color = dataset) + 
  geom_line(aes(group = dataset)) + 
  facet_grid(.~parameter,scales = "free") + labs(x = "Average Student Attempts", y = "Standard Deviation", title = "Percentage drop in Standard Deviation of Sampling Mean Difference") +
  geom_label(aes(label = paste0(round(diff_from_first*100,2),"%"))) + 
  scale_y_continuous(labels=scales::percent_format(accuracy = 1))


```

# 2 Sample Z Test


```{r}

df.mean_diff  %>% filter(dataset == "Social Psychology" | avg_attempts > 14) %>%
  
  
  ggplot() + 
  aes(y=avg_attempts, x=Z_test) +
  
  geom_density_ridges(aes(height = ..density..), 
                      stat = "density", rel_min_height=0.01, 
                      alpha = 0.3
                       ) +
  
  #labs(y = "Student count (average) attempting each item", x = "Mean Difference between partitions", title = "") + 
  labs(y = "Student count (average) attempting each item", x = "Item-Parameter Bias Relative difference", title = "") + 
  geom_vline(aes(xintercept = 1.6), linetype = 2) + 
  geom_vline(aes(xintercept = -1.6), linetype = 2) + 
  theme_pubclean() + 
  facet_grid(dataset ~ parameter, scales = "free", 
             labeller = label_wrap_gen(width = 10, multi_line = FALSE))  + 
    theme(axis.text.x = element_text(size = 12), 
          axis.text.y = element_text(size = 10.5),
          strip.text.x = element_text(size = 14),
          strip.text.y = element_text(size = 14),
          axis.title.x = element_text(size = 18),
          axis.title.y = element_text(size = 16)
          
          ) + scale_x_continuous(limits = c(-3,3), breaks = seq(-3,3,1))

  
```


```{r}

df.mean_diff  %>% filter(dataset == "Social Psychology" | avg_attempts > 14) %>%
  
  
  ggplot() + 
  aes(y=avg_attempts, x=Z_test) +
  
  geom_density_ridges2(aes(height = ..density..), 
                       stat = "binline", rel_min_height=0.01, 
                       alpha = 0.3
                       ) +
  
  #labs(y = "Student count (average) attempting each item", x = "Mean Difference between partitions", title = "") + 
  labs(y = "Student count (average) attempting each item", x = "Item-Parameter Bias Z score", title = "") + 
  geom_vline(aes(xintercept = 1.6), linetype = 2) + 
  geom_vline(aes(xintercept = -1.6), linetype = 2) + 
  theme_pubclean() + 
  facet_grid(dataset ~ parameter, scales = "free", 
             labeller = label_wrap_gen(width = 10, multi_line = FALSE))  + 
    theme(axis.text.x = element_text(size = 12), 
          axis.text.y = element_text(size = 10.5),
          strip.text.x = element_text(size = 14),
          strip.text.y = element_text(size = 14),
          axis.title.x = element_text(size = 18),
          axis.title.y = element_text(size = 16)
          
          ) + scale_x_continuous(limits = c(-3,3), breaks = seq(-3,3,1))

  
```

# EDA Model Fit

```{r}


df.fit.plot.attempts %>% arrange(sample_size) %>% distinct(group, sample_size, dataset) %>% filter(dataset == "Social Psychology (Upsample)") %>% filter(group == "Partition 2")

```

```{r}

df.fit.plot.attempts %>% filter(group == "Partition 1") %>%
  
  ggplot() +
  aes(x=attempts, y=sampling_error, color = dataset, group = group) +
  geom_line() +
  geom_label(aes(label = round(sampling_error,6)))+
  geom_hline(aes(yintercept=0.05),linetype="dotted") +
  #scale_x_continuous(limits = c(0,300)) + 
  facet_wrap(dataset~.,scales = "free")
  
  
  
  

```





