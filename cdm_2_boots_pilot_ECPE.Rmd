---
title: "CDM Demo"
output: html_notebook
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
```

# Read Data
```{r}
rm(list = ls())

df.X <- read_csv("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\X.csv") %>% mutate_all(as.integer)
df.Q <- read_csv("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\Q.csv") %>% mutate_all(as.integer)


X = df.X %>% select(-SubjectID, -File) %>% rename_all(function(x) paste0("Q",x))
Q = df.Q %>% select(-Q_UNIQUE_ID) %>% rename_all(function(x) paste0("S",x))


X = data.ecpe$data %>% select(-id)
Q = data.ecpe$q.matrix

#Q <- data.timss11.G4.AUT.part$q.matrix1
#X <- data.timss11.G4.AUT.part$data[,paste(Q$item)]
#Q <- Q[,-1]


```

```{r}
X 
```

```{r }
Q
```

```{r}
#n=dim(X)[1]
#X <- X %>% sample_n(size = n, replace = FALSE)
```

# Student Performance


# Bootstrap Sample 

Boot requires a custom function that would return row wise stats. In case of dataframe, each row is considered as a multi-variate observation. First parameter of the custom function takes the data input and second parameter takes the importance of data given current bootstrap iteration. stype defines second parameter.



```{r}



#X <- as.data.frame(X) 
#Q <- as.data.frame(Q) 




#model_dina <- gdina(data =  data.ecpe$data[,-1] , q.matrix =  data.ecpe$q.matrix, maxit = 10, rule = "GDINA2")

model_dina <- din(data = X, q.matrix =  Q, progress = FALSE)

```



# Calculate item parameters

```{r}

total_cdm_fn <- function(df, i = 1:dim(df)[1]) {
  
  #print(dim(df))
  #browser()
  #df.t <- X
  df.t <- df[i,]
  
  df.t.s1 <- df.t #%>% select(E1:E28) 

  ###########################
  
  df.cdm <- CDM::din(df.t.s1, Q, progress=FALSE)
 
  
   df.t1 <- tibble("value" = df.cdm$slip$est, "key" = paste0("s1_slip_E", seq(1,length(df.cdm$slip$est),1))) %>% 
     spread(key = "key", value = "value") %>% 
     select(!!!paste0("s1_slip_E", seq(1,length(df.cdm$slip$est),1)))
 
  
  df.t2 <- tibble("value" = df.cdm$guess$est, "key" = paste0("s1_guess_E", seq(1,length(df.cdm$guess$est),1))) %>% 
    spread(key = "key", value = "value") %>% 
    select(!!!paste0("s1_guess_E", seq(1,length(df.cdm$guess$est),1)))
  
  
  df.t <- cbind(df.t1, df.t2)
  
 return(as.matrix(df.t))
    
} 

t_cdm <- total_cdm_fn(X)

t_cdm[,1]
```

```{r}
# Need to repeat this block with difference student size in X. 
sample_size = 0.1
# Let's suffle X
X <- X %>% sample_frac(1)

#Divide X to 2 parts
X.p1 <- X %>% head(round(dim(X)[1]/2))
X.p2 <- X %>% tail(round(dim(X)[1]/2))


get_mean_sample_error <- function(sample_size) {

df.X.p1 <- X.p1 %>% sample_frac(size = sample_size)
df.X.p2 <- X.p2 %>% sample_frac(size = sample_size)

print(paste0("sample p1:", dim(df.X.p1)[1], "; sample p2:", dim(df.X.p2)[1]))

print("Starting Boot 1")
X.bt.1 <- boot(data = df.X.p1 , statistic = total_cdm_fn, R = 10, stype = "i") # R needs to be 2 atleast for below code to work correctly

print("Starting Boot 2")
X.bt.2 <- boot(data = df.X.p2 , statistic = total_cdm_fn, R = 10, stype = "i")

question_size = dim(X)[2]

df.s1_slip <- X.bt.1$t[,1:question_size] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Partition 1")
df.s1_guess <- X.bt.1$t[,(question_size+1):ncol(X.bt.1$t)] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Partition 1")


df.s2_slip <- X.bt.2$t[,1:question_size] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Partition 2")
df.s2_guess <- X.bt.2$t[,(question_size+1):ncol(X.bt.1$t)] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Partition 2")


df.data.sim <- df.s1_slip %>% bind_rows(df.s1_guess) %>% bind_rows(df.s2_slip) %>% bind_rows(df.s2_guess) 


col_names <- colnames(df.data.sim %>% select(-group, -parameter) ) 

df.data <- df.data.sim %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% 
  
  mutate(questions = factor(questions, 
                                   labels = colnames(X),
                                   levels = col_names, # All unique values of questions header return by boot function v1:v_
                                   ordered = TRUE)) %>% 
  
  group_by(group, parameter, questions) %>% 
  summarise( 
             total_count = n(),   
             na_count = sum(is.na(item_parameters)),
             sampling_mean = mean(item_parameters), 
             sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)), 
             sampling_variance = sampling_error^2
             ) %>% 
  
  ungroup() %>% 
  mutate(sample_size = dim(df.X.p1)[1])

df.data.agg <- df.data.sim %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% 
  
   mutate(questions = factor(questions, 
                                   labels = colnames(X),
                                   levels = col_names, # All unique values of questions header return by boot function v1:v_
                                   ordered = TRUE)) %>% 
  
  group_by(group, parameter, questions) %>% 
  summarise( sampling_mean = mean(item_parameters), 
             sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)), 
             sampling_variance = sampling_error^2
             ) %>% 
  
  group_by(group, parameter) %>% 
  summarise(sampling_error_mean = sqrt(sum(sampling_variance)/(n()-1))) %>%
  
  ungroup() %>% 
  mutate(sample_size = dim(df.X.p1)[1])


return(list(df.data,df.data.agg))

}
```


```{r}
df.t <- get_mean_sample_error(0.1)

df.error <- df.t[[1]]
df.error.agg <- df.t[[2]]

for(i in seq(0.2, 1, 0.1)) {
  
  df.t <- get_mean_sample_error(i)
  
  df.error.t <- df.t[[1]]
  df.error.agg.t <- df.t[[2]]

   df.error <- df.error %>% union(
    
    df.error.t
  )
  
  df.error.agg <- df.error.agg %>% union(
    
    df.error.agg.t
  )
  
}
```


```{r}
df.error <- df.error %>% mutate(ratio = factor(round(sample_size/dim(X)[2]))) %>% arrange(sample_size, questions)
df.error
```

```{r}
df.error.agg <- df.error.agg %>% mutate(ratio = factor(round(sample_size/dim(X)[2]))) %>% arrange(sample_size, parameter, group)
df.error.agg
```

```{r}

df.error.plot <- df.error %>% inner_join(
  df.error.agg
) 

df.error.plot

```

```{r}

df.error.agg %>% 
  ggplot() + 
  aes(x=ratio, y=sampling_error_mean, color = group, fill = group, group = group) +
  geom_line() +
  labs(x="Student to Item Ratio") +
  facet_wrap(parameter~.)

```


```{r}

df.error %>% mutate(ratio = factor(round(sample_size/dim(X)[2]))) %>% 
  ggplot() + 
  aes(x=ratio, y=sampling_error, fill = group) +
  geom_boxplot(alpha = 0.4) +
  labs(x="Student to Item Ratio") +
  facet_wrap(parameter~.)


```

```{r}

df.error.plot %>% 
  ggplot() + 
  aes(x=ratio, y=sampling_error, fill = group) +
  geom_violin(alpha = 0.6, trim = FALSE, color = "white") +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
  geom_point(aes(y=sampling_error_mean), size = 1) + 
  
  labs(x="Student to Item Ratio") +
  facet_grid(parameter~group)

```


```{r}

df.error.plot %>%
  ggplot() + 
  aes(x=ratio, y=sampling_error, fill = group) +
  geom_jitter(alpha = 0.09, width = 0.15) +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
  geom_point(aes(y=sampling_error_mean), size = 1) + 
  
  labs(x="Student to Item Ratio") +
  facet_grid(parameter~group)

```



