---
title: "CDM Demo"
output: html_notebook
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)

```

# Read Data
```{r}
rm(list = ls())

X = data.ecpe$data
Q = data.ecpe$q.matrix

```

```{r}
X
```

# Student Performance
## Total marks for each student

```{r}
df.data <- X
df.t <- X %>% mutate(total_marks = rowSums(.[-1]), grand_total = 28, percentage = total_marks / grand_total, 
                     grades = ifelse(percentage >= 0.9, "A",
                                     ifelse(percentage >= 0.8 & percentage < 0.9, "B",
                                            ifelse(percentage >= 0.7 & percentage < 0.8, "C",
                                                   ifelse(percentage >= 0.6 & percentage < 0.7, "D", "F")))
                                     ), grades = factor(grades)) %>% 
  mutate(mastery = factor(case_when(
    grades == "A" | grades == "B" ~ "Mastery",
    grades == "B" | grades == "C" ~ "Average",
    grades == "D" | grades == "F" ~ "Non-Mastery"), levels = c("Mastery", "Average" ,"Non-Mastery"), ordered = TRUE)) %>%
  
  select(id, total_marks, grand_total, percentage, grades, mastery)

df.data = df.data %>% inner_join(df.t)

glimpse(df.data)

```

Density plot for total marks acheived by students.
```{r}
ggplot(df.t) + aes(x=total_marks, fill = grades) + geom_histogram(binwidth = 1, alpha = 0.5) + geom_vline(aes(xintercept = median(df.t$total_marks), color = "Median Marks")) + 
  geom_vline( aes(xintercept = mean(df.t$grand_total),color = "Max Marks")) + scale_x_continuous(breaks = seq(5,30,1)) + 
  theme_pubclean()  + labs(color = "") #+ scale_fill_brewer(palette="Pastel1")
```

```{r}
ggplot(df.t) + aes(x=percentage, fill = mastery) + geom_density(alpha = 0.4) +  
   labs(color = "") + scale_x_continuous(breaks = seq(0,1, 0.05)) +  facet_wrap(mastery~.) + stat_mean(aes(color = "Mean", y=percentage), show.legend = TRUE)
```


# Item Performance
## Questions least answered


Below graph shows that none of the questions have been completely answered by students.
```{r}
df.t <- df.data %>% select(id, E1:E28) %>% gather(key="question", value = "answered", -id, factor_key = TRUE) %>% group_by(question) %>% summarise(total_answered = sum(answered), total_students = dim(X)[1], percent = total_answered/total_students, type=ifelse(percent < 0.5, "Difficult Question", "Normal Question"))
df.t

ggplot(df.t) + aes(x=question, y=total_answered, fill = type) + geom_col(alpha = 0.6) + geom_hline(aes(yintercept = dim(X)[1], color = "Total Students"))  + 
  geom_hline(aes(yintercept = min(df.t$total_answered), color = " Least Answered Question"))  + 
  geom_hline(aes(yintercept = max(df.t$total_answered), color = " Most Answered Question"))  + theme_pubclean() + labs(color = "", fill="") 
```

## By Grades
```{r}

df.t <- df.data %>% select(id, grades, E1:E28) %>% gather(key="question", value = "answered", -id, -grades, factor_key = TRUE) %>% group_by(question, grades) %>% summarise(total_answered = sum(answered), total_students = n(), percent = total_answered/total_students, type=ifelse(percent < 0.5, "Difficult Question", "Normal Question"))
df.t


ggplot(df.t) + aes(x=question, y=percent, fill = type) + geom_col(alpha = 0.6, position = position_stack() ) + theme_pubclean() + facet_grid(grades~.) + labs(y = "Percentage", title = "Percentage of students in a particular grade answering a particular Item")+ theme_pubclean() + labs(color = "", fill="")

#ggplot(df.t) + aes(x=question, y=percent, fill = grades) + geom_col(alpha = 0.6, position = position_stack() ) + theme_pubclean() + facet_grid(grades~type) + labs(y = "Percentage", title = "Percentage of students in a particular grade answering a particular Item")
```

```{r}
df.t <- df.data %>% select(id, mastery, E1:E28) %>% gather(key="question", value = "answered", -id, -mastery, factor_key = TRUE) %>% group_by(question, mastery) %>% summarise(total_answered = sum(answered), total_students = n(), percent = total_answered/total_students)

ggplot(df.t) + aes(x=mastery, y=percent, fill = mastery) + geom_col(stat = "identity", alpha = 0.6 ) + theme_pubclean()+ labs(y = "Percent answered out of total in a grade", title = "How Many students in a particular grade answered a particular Item") + facet_wrap(.~question)

```


# Bootstrap Sample 

Boot requires a custom function that would return row wise stats. In case of dataframe, each row is considered as a multi-variate observation. First parameter of the custom function takes the data input and second parameter takes the importance of data given current bootstrap iteration. stype defines second parameter.

```{r}
total_percent_fn <- function(df, i, df.t2 = df.data) {
  
  df.t <- df.t2[i,]
  df.master <- df.t %>% filter(grades == "A" | grades == "B")
  df.non_master <- df.t %>% filter(grades != "A" & grades != "B")
  
  
  return(c(mean(df.master$percentage), mean(df.non_master$percentage)))
  #return (mean(df.t$percentage))

  #return (df.t)
  
} 

X.bt <- boot(data = X %>% select(-id), statistic = total_percent_fn, R = 1000, stype = "i")


summary(X.bt)

plot(X.bt)

boot.ci(X.bt, type = c("norm", "basic", "perc", "stud"))
```


```{r}
glimpse(X.bt$t)

```

# Now the actual

See how the items are performing
```{r}

df.data %>% select(id, mastery, E1:E28) %>% gather(key = "questions", value = "answer", -id, -mastery, factor_key = TRUE) %>% group_by(mastery, questions) %>% summarize( percent_questions_answered = sum(answer) / n()) %>% 
  ggplot() + aes(x=questions, y = percent_questions_answered, color = mastery) + geom_point() + facet_grid(mastery~.) + theme_pubclean()

```



```{r}
total_percent_fn <- function(df, i = 1:dim(df)[1]) {
  
  #browser()
  df.t <- df[i,]
  #df.t <- df.data
 df.t <- df.t %>% select(id, mastery, E1:E28) %>% gather(key = "questions", value = "answer", -id, -mastery, factor_key = TRUE) %>% group_by(mastery, questions) %>% summarize( percent_questions_answered = sum(answer) / n()) %>% unite("questions",mastery, questions) %>% ungroup()
 
 col_order = df.t$questions
 
 df.t1 <- df.t %>% spread(key=1, value = percent_questions_answered, convert = TRUE)  %>% select(!!!col_order)
 
 return(as.matrix(df.t1))
    
} 

t <- total_percent_fn(df.data)

t
```


```{r}

X.bt <- boot(data = df.data , statistic = total_percent_fn, R = 1000, stype = "i")

plot(X.bt)
```

```{r}
#X.bt$t
```

# Extract Data structure for different data divisions

```{r}

df.group_mastery <- X.bt$t[,1:28] %>% as_tibble() %>% mutate(group = "Mastery")
df.group_ave <- X.bt$t[,29:56] %>% as_tibble() %>% mutate(group = "Average")
df.group_non_mastery <- X.bt$t[,57:84] %>% as_tibble() %>% mutate(group = "Non-Mastery")

df.data.sim <- df.group_mastery %>% bind_rows(df.group_ave) %>% bind_rows(df.group_non_mastery)
df.data.sim


```

```{r}
df.t <- df.data.sim
col_names <- colnames(df.t %>% select(-group)) %>% str_replace("V","Q")

df.t %>% gather(key = "questions", value="percent_questions_answered", -group) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, questions) %>% summarise( sampling_mean = mean(percent_questions_answered), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((percent_questions_answered - sampling_mean)^2)/(n() - 1)) )

```

```{r}

df.t %>% gather(key = "questions", value="percent_questions_answered", -group) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, questions) %>% summarise( sampling_mean = mean(percent_questions_answered), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((percent_questions_answered - sampling_mean)^2)/(n() - 1)) ) %>% 
  
  ggplot() + aes(x=questions, y = sampling_mean, color = group) + facet_grid(group ~ .)  +geom_errorbar( aes(ymin=sampling_mean - sampling_error, 
                                                                                                                          ymax=sampling_mean + sampling_error), width=.2) + geom_point(size = 1)


```


```{r}

library(CDM)

model_dina <- din(X %>% select(-id), Q)
model_dina$slip

```



# Calculate item parameters

```{r}
library(CDM)
total_cdm_fn <- function(df, i = 1:dim(df)[1]) {
  
  #browser()
  df.t <- df[i,]
  #df.t <- df.data
 
  df.t.mastery <- df.t %>% filter(mastery == "Mastery") %>% select(E1:E28)
  df.t.ave <- df.t %>% filter(mastery == "Average") %>% select(E1:E28)
  df.t.non_mastery <- df.t %>% filter(mastery == "Non-Mastery") %>% select(E1:E28)
 
  ###########################
  
  df.cdm <- CDM::din(df.t.mastery, Q, progress=FALSE)
 
   df.t1 <- tibble("value" = df.cdm$slip$est, "key" = paste0("mastery_slip_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("mastery_slip_E", seq(1,28,1)))
 
  
  df.t2 <- tibble("value" = df.cdm$guess$est, "key" = paste0("mastery_guess_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("mastery_guess_E", seq(1,28,1)))
  
  ###########################
 
  df.cdm <- CDM::din(df.t.ave, Q, progress=FALSE)
 
  df.t3 <- tibble("value" = df.cdm$slip$est, "key" = paste0("average_slip_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("average_slip_E", seq(1,28,1)))
 
  
  df.t4 <- tibble("value" = df.cdm$guess$est, "key" = paste0("average_guess_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("average_guess_E", seq(1,28,1)))
  
  #############################
  
  df.cdm <- CDM::din(df.t.non_mastery, Q, progress=FALSE)
 
  df.t5 <- tibble("value" = df.cdm$slip$est, "key" = paste0("non_mastery_slip_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("non_mastery_slip_E", seq(1,28,1)))
 
  
  df.t6 <- tibble("value" = df.cdm$guess$est, "key" = paste0("non_mastery_guess_E", seq(1,28,1))) %>% spread(key = "key", value = "value") %>% select(!!!paste0("non_mastery_guess_E", seq(1,28,1)))
  
  
  df.t <- cbind(df.t1, df.t2, df.t3, df.t4, df.t5, df.t6)
  
 return(as.matrix(df.t))
    
} 

t <- total_cdm_fn(df.data)

t 
```

```{r}

X.bt <- boot(data = df.data , statistic = total_cdm_fn, R = 1000, stype = "i")

plot(X.bt)
```

```{r}

df.m_slip <- X.bt$t[,1:28] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Mastery")
df.m_guess <- X.bt$t[,29:56] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Mastery")


df.ave_slip <- X.bt$t[,57:84] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Average")
df.ave_guess <- X.bt$t[,85:112] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Average")


df.nm_slip <- X.bt$t[,113:140] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Non-Mastery")
df.nm_guess <- X.bt$t[,141:168] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Non-Mastery")

df.data.sim <- df.m_slip %>% bind_rows(df.m_guess) %>% 
  bind_rows(df.ave_slip) %>% bind_rows(df.ave_guess) %>% 
  bind_rows(df.nm_slip) %>% bind_rows(df.nm_guess)

df.data.sim

```

```{r}
df.t <- df.data.sim
col_names <- colnames(df.t %>% select(-group)) %>% str_replace("V","Q")

df.t %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, parameter, questions) %>% summarise( sampling_mean = mean(item_parameters), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)) )
```


```{r}

df.t %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% group_by(group, parameter, questions) %>% summarise( sampling_mean = mean(item_parameters), 
                                                                                                                                                                                                                                 sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)) ) %>% 
  
  ggplot() + aes(x=questions, y = sampling_mean, color = parameter) + facet_grid(group ~ .  )  +geom_errorbar( aes(ymin=sampling_mean - sampling_error, 
                                                                                                                          ymax=sampling_mean + sampling_error), width=.2) + geom_point(size = 1) + theme(strip.text.y = element_text(angle = 0)) + ggtitle("Item Parameters estimated over 1000 Bootstrap samples")


```
