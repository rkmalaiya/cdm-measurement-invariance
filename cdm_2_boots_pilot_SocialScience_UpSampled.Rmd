---
title: "CDM Pilot Study for Social Science"
output: html_notebook
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
```

# Read Data
```{r}
rm(list = ls())
source('calculate_parameters.R')
options(max.print=100)


df.X <- read_csv("..\\data\\FirstYearProject\\X.csv") %>% mutate_all(as.integer)
df.Q <- read_csv("..\\data\\FirstYearProject\\Q.csv") %>% mutate_all(as.integer)


X = df.X %>% select(-SubjectID, -File) %>% rename_all(function(x) paste0("Q",x))
Q = df.Q %>% select(-Q_UNIQUE_ID) %>% rename_all(function(x) paste0("S",x))
X <- as.data.frame(X) 
Q <- as.data.frame(Q) 

#X = data.ecpe$data %>% select(-id)
#Q = data.ecpe$q.matrix

#Q <- data.timss11.G4.AUT.part$q.matrix1
#X <- data.timss11.G4.AUT.part$data[,paste(Q$item)]
#Q <- Q[,-1]


```

```{r}
X 
```




```{r }
Q
```

# Summary of Attempts

## Attempts seen by each item
```{r}

summary(colSums(!is.na(X)))

```

## Questions shown to each student

```{r}

X %>% mutate(na_per_row = rowSums(is.na(.[1:47]))) %>% group_by(na_per_row) %>% tally()


```



# Upsampling
```{r}
#n=dim(X)[1]
X <- X %>% sample_frac(20, replace = TRUE)
```

```{r}
percent_na <- round((sum(is.na(X)) / (dim(X)[1] * dim(X)[2])) * 100,2)
percent_na
```


# Student Performance


# Bootstrap Sample 

Boot requires a custom function that would return row wise stats. In case of dataframe, each row is considered as a multi-variate observation. First parameter of the custom function takes the data input and second parameter takes the importance of data given current bootstrap itestudent_question_ration. stype defines second parameter.



```{r}



#X <- as.data.frame(X) 
#Q <- as.data.frame(Q) 




#model_dina <- gdina(data =  data.ecpe$data[,-1] , q.matrix =  data.ecpe$q.matrix, maxit = 10, rule = "GDINA2")

model_dina <- din(data = X, q.matrix =  Q, progress = FALSE)
model_dina
```



# Calculate item parameters

```{r}
# Let's suffle X
#X <- X %>% sample_frac(20, replace = TRUE)
#dim(X)
#Divide X to 2 parts
#X.p1 <- X %>% head(round(dim(X)[1]/2))
#X.p2 <- X %>% tail(round(dim(X)[1]/2))


```



```{r message=FALSE, warning=FALSE}

df.t <- get_sample_sizes(dim(X)[1], dim(X)[2])

student_question_ratios <- df.t[[1]]
sample_sizes <- df.t[[2]]

colSums(!is.na(X)) 

df.t <- get_mean_sample_error(X, Q, sample_sizes[1], student_question_ratios[1])

df.error <- df.t[[1]]
df.error.agg <- df.t[[2]]
df.error.fit <- df.t[[3]]
df.data.sim.item <- df.t[[4]]

```


```{r message=FALSE, warning=FALSE}

for(i in 2:length(sample_sizes)) {
  
  df.t <- get_mean_sample_error(X, Q, sample_sizes[i], student_question_ratios[i])
  
  df.error.t <- df.t[[1]]
  df.error.agg.t <- df.t[[2]]
  df.error.fit.t <- df.t[[3]]
  df.data.sim.item.t <- df.t[[4]]
  
  df.error <- df.error %>% union(
    
    df.error.t
  )
  
  df.error.agg <- df.error.agg %>% union(
    
    df.error.agg.t
  )
  
  df.error.fit <- df.error.fit %>% union(
    
    df.error.fit.t
  )  
  
  df.data.sim.item <- df.data.sim.item %>% union(
  
  df.data.sim.item.t
  )
  
}


#debugonce(get_mean_sample_error)

```

```{r}
write_rds(df.error, "..\\data\\FirstYearProject\\df_error_upsample_socialscience.rds")

write_rds(df.error.agg, "..\\data\\FirstYearProject\\df_error_agg_upsample_socialscience.rds")

write_rds(df.error.fit, "..\\data\\FirstYearProject\\df_error_fit_upsample_socialscience.rds")

write_rds(df.data.sim.item, "..\\data\\FirstYearProject\\df_data_sim_item_upsample_socialscience.rds")
```


```{r}
df.error <- read_rds("..\\data\\FirstYearProject\\df_error_upsample_socialscience.rds")

df.error.agg <- read_rds("..\\data\\FirstYearProject\\df_error_agg_upsample_socialscience.rds")

df.error.fit <- read_rds("..\\data\\FirstYearProject\\df_error_fit_upsample_socialscience.rds")
```



```{r}
df.error <- df.error %>% arrange(sample_size, questions) %>% mutate(student_question_ratio = factor(student_question_ratio, levels = as.character(unique(student_question_ratio)), ordered = TRUE  ))
df.error
```

```{r}
#df.error.agg <- df.error.agg %>% arrange(sample_size, parameter, group) %>% mutate(student_question_ratio = factor(student_question_ratio, levels = as.character(unique(student_question_ratio)), ordered = TRUE  ))
#df.error.agg
```

```{r}

df.error.plot <- df.error 
#%>% inner_join(
#  df.error.agg
#) 

df.error.plot

```

```{r}

#df.error.agg %>% 
#  ggplot() + 
#  aes(x=student_question_ratio, y=sampling_error_mean, color = group, fill = group, group = group) +
#  geom_line() +
#  labs(x="Student to Item student_question_ratio") +
#  facet_wrap(parameter~.)

```


```{r}

df.error %>% 
  ggplot() + 
  aes(x=student_question_ratio, y=sampling_error, fill = group) +
  geom_boxplot(alpha = 0.4) +
  labs(x="Student to Item student_question_ratio") +
  facet_wrap(parameter~.)


```

```{r}

#df.error.plot %>% 
#  ggplot() + 
#  aes(x=student_question_ratio, y=sampling_error, fill = group) +
#  geom_violin(alpha = 0.6, trim = FALSE, color = "white") +
#  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
#  geom_point(aes(y=sampling_error_mean), size = 1) + 
  
#  labs(x="Student to Item student_question_ratio") +
#  facet_grid(parameter~group)

```



# Model Fit

```{r}
df.fit.plot <- df.error.fit  %>% select(parameter, fit, group, sampling_error, sample_size, attempts) %>% arrange(attempts, sample_size) %>% 
  mutate(sampling_error_3= round(sampling_error,3),
         attempts_bin = cut(round(attempts), breaks = 6, right = TRUE, ordered_result = TRUE)
         )

df.fit.plot 
```


```{r}
df.fit.plot  %>% select(parameter,fit,group,sample_size,attempts, sampling_error_3) %>%
  spread(key="group", value = "sampling_error_3") %>% arrange(sample_size) %>%
  
  
  
  ggplot() + 
  aes(x=`Partition 1`, y=`Partition 2`, color=attempts) +
  geom_jitter() +
  
  labs() +
  facet_grid(parameter~fit, scales = "free") + 
  ggtitle("Sampling Error of Each Item")

```

```{r}
df.fit.plot  %>% 
  arrange(sample_size) %>%
  
  
  
  ggplot() + 
  aes(x=attempts_bin, y=sampling_error, fill=group) +
  geom_col() +
  
  labs() +
  facet_grid(parameter~group, scales = "free") + 
  ggtitle("Sampling Error of Model fit")

```
