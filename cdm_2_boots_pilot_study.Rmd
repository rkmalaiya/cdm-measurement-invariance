---
title: "CDM Demo"
output: html_notebook
---


```{r}
library(ggplot2)
library(ggpubr)
library(CDM)
library(boot)
library(tidyverse)
library(stringi)
library(stringr)
```

# Read Data
```{r}
rm(list = ls())

df.X <- read_csv("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\X.csv") %>% mutate_all(as.integer)
df.Q <- read_csv("C:\\Users\\rkm160630\\OneDrive - The University of Texas at Dallas\\Ritesh Folder\\PhD\\FirstYearProject\\data\\Q.csv") %>% mutate_all(as.integer)


X = df.X %>% select(-SubjectID, -File) %>% rename_all(function(x) paste0("Q",x))
Q = df.Q %>% select(-Q_UNIQUE_ID) %>% rename_all(function(x) paste0("S",x))


X = data.ecpe$data %>% select(-id)
Q = data.ecpe$q.matrix

#Q <- data.timss11.G4.AUT.part$q.matrix1
#X <- data.timss11.G4.AUT.part$data[,paste(Q$item)]
#Q <- Q[,-1]


```

```{r paged.print=FALSE}
X
```

```{r paged.print=FALSE}
Q
```

```{r}
n=dim(X)[1]
#X <- X %>% sample_n(size = n, replace = FALSE)
```

# Student Performance


# Bootstrap Sample 

Boot requires a custom function that would return row wise stats. In case of dataframe, each row is considered as a multi-variate observation. First parameter of the custom function takes the data input and second parameter takes the importance of data given current bootstrap iteration. stype defines second parameter.



```{r}



X <- as.data.frame(X) 
Q <- as.data.frame(Q) 




#model_dina <- gdina(data =  data.ecpe$data[,-1] , q.matrix =  data.ecpe$q.matrix, maxit = 10, rule = "GDINA2")

model_dina <- din(data = X, q.matrix =  Q, progress = FALSE)

```



# Calculate item parameters

```{r}

total_cdm_fn <- function(df, i = 1:dim(df)[1]) {
  
  #print(dim(df))
  #browser()
  #df.t <- X
  df.t <- df[i,]
  
  df.t.s1 <- df.t #%>% select(E1:E28) 

  ###########################
  
  df.cdm <- CDM::din(df.t.s1, Q, progress=FALSE)
 
  
   df.t1 <- tibble("value" = df.cdm$slip$est, "key" = paste0("s1_slip_E", seq(1,length(df.cdm$slip$est),1))) %>% 
     spread(key = "key", value = "value") %>% 
     select(!!!paste0("s1_slip_E", seq(1,length(df.cdm$slip$est),1)))
 
  
  df.t2 <- tibble("value" = df.cdm$guess$est, "key" = paste0("s1_guess_E", seq(1,length(df.cdm$guess$est),1))) %>% 
    spread(key = "key", value = "value") %>% 
    select(!!!paste0("s1_guess_E", seq(1,length(df.cdm$guess$est),1)))
  
  
  df.t <- cbind(df.t1, df.t2)
  
 return(as.matrix(df.t))
    
} 

t_cdm <- total_cdm_fn(X)

t_cdm[,1]
```

```{r}
# Need to repeat this block with difference student size in X. 
sample_size = 0.1

get_mean_sample_error <- function(X, sample_size) {

X <- X %>% sample_frac(size = sample_size)
print(dim(X))
X.p1 <- X %>% sample_frac(size = 0.5)
X.p2 <- X %>% anti_join(X.p1)

print("Starting Boot 1")
X.bt.1 <- boot(data = X , statistic = total_cdm_fn, R = 1000, stype = "i")

print("Starting Boot 2")
X.bt.2 <- boot(data = X , statistic = total_cdm_fn, R = 1000, stype = "i")

size = dim(X)[2]

df.s1_slip <- X.bt.1$t[,1:size] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Partition 1")
df.s1_guess <- X.bt.1$t[,(size+1):56] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Partition 1")


df.s2_slip <- X.bt.2$t[,1:size] %>%  as_tibble() %>% mutate(parameter = "Slip", group = "Partition 2")
df.s2_guess <- X.bt.2$t[,(size+1):56] %>% as_tibble() %>% mutate(parameter = "Guess", group = "Partition 2")


df.data.sim <- df.s1_slip %>% bind_rows(df.s1_guess) %>% bind_rows(df.s2_slip) %>% bind_rows(df.s2_guess) 


col_names <- colnames(df.data.sim %>% select(-group)) %>% str_replace("V","Q")
colnames(df.data.sim) <- colnames(df.data.sim) %>% str_replace("V","Q")

df.data <- df.data.sim %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% 
  
  mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% 
  
  group_by(group, parameter, questions) %>% 
  summarise( sampling_mean = mean(item_parameters), 
             sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)), 
             sampling_variance = sampling_error^2
             ) %>% 
  
  ungroup() %>% 
  mutate(sample_size = dim(X)[1])

df.data.agg <- df.data.sim %>% gather(key = "questions", value="item_parameters", -group, -parameter) %>% 
  
  mutate(questions = factor(str_replace(questions, "V","Q"), levels = col_names, ordered = TRUE)) %>% 
  
  group_by(group, parameter, questions) %>% 
  summarise( sampling_mean = mean(item_parameters), 
             sampling_error = sqrt(sum((item_parameters - sampling_mean)^2)/(n() - 1)), 
             sampling_variance = sampling_error^2
             ) %>% 
  
  group_by(group, parameter) %>% 
  summarise(sampling_error_mean = sqrt(sum(sampling_variance)/(n()-1))) %>%
  
  ungroup() %>% 
  mutate(sample_size = dim(X)[1])


return(list(df.data,df.data.agg))

}

df.t <- get_mean_sample_error(X, 0.1)

df.error <- df.t[[1]]
df.error.agg <- df.t[[2]]

for(i in seq(0.2, 1, 0.1)) {
  
  df.t <- get_mean_sample_error(X, i)
  
  df.error.t <- df.t[[1]]
  df.error.agg.t <- df.t[[2]]

   df.error <- df.error %>% union(
    
    df.error.t
  )
  
  df.error.agg <- df.error.agg %>% union(
    
    df.error.agg.t
  )
  
}
```


```{r}
df.error.agg

```

```{r}

df.error.agg %>% 
  ggplot() + 
  aes(x=sample_size/dim(X)[2], y=sampling_error_mean, color = group, fill = group, group = group) +
  geom_line() +
  labs(x="Student to Item Ratio") +
  facet_wrap(parameter~.)

```


```{r}

df.error %>% mutate(ratio = factor(round(sample_size/dim(X)[2]))) %>% 
  ggplot() + 
  aes(x=ratio, y=sampling_error, fill = group) +
  geom_boxplot(alpha = 0.4) +
  labs(x="Student to Item Ratio") +
  facet_wrap(parameter~.)


```

```{r}

df.error %>% inner_join(
  df.error.agg
) %>% mutate(ratio = factor(round(sample_size/dim(X)[2]))) %>% 
  ggplot() + 
  aes(x=ratio, y=sampling_error, fill = group) +
  geom_violin(alpha = 0.6, trim = FALSE, color = "white") +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
  geom_point(aes(y=sampling_error_mean), size = 1) + 
  
  labs(x="Student to Item Ratio") +
  facet_grid(parameter~group)

```


```{r}

df.error %>% inner_join(
  df.error.agg
) %>% mutate(ratio = factor(round(sample_size/dim(X)[2]))) %>% 
  ggplot() + 
  aes(x=ratio, y=sampling_error, fill = group) +
  geom_jitter(alpha = 0.09, width = 0.15) +
  geom_line(aes(y=sampling_error_mean, color = group, group = group), linetype = 1, size = 1) + 
  geom_point(aes(y=sampling_error_mean), size = 1) + 
  
  labs(x="Student to Item Ratio") +
  facet_grid(parameter~group)

```



